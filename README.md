# 中间生成 (Middle Generation) 扩展

![版本](https://img.shields.io/badge/版本-1.0.0-blue)
![作者](https://img.shields.io/badge/作者-iron0rca-orange)

一个为 [SillyTavern](https://github.com/SillyTavern/SillyTavern) 设计的高级扩展，专注于提供强大的中间消息生成控制功能。通过此扩展，用户可以在对话历史的任意位置开始生成新内容，而不是只能在对话末尾追加，极大地提升了对话编辑和故事创作的灵活性。

## 为什么需要这个扩展？

在正常的聊天过程中，我们只能在对话的末尾追加新消息。但实际使用中，我们经常需要：

1. **修改上一条消息**：AI生成的内容不符合预期，需要重新生成
2. **探索不同故事分支**：在关键节点尝试不同的发展方向
3. **编辑已有对话**：完善或修正历史对话内容

这个扩展就是为了解决这些问题而设计的。在SillyTavern官方不支持中间生成功能的情况下，这个扩展极大地扩展了酒馆的可用范围，让用户能够更灵活地控制对话生成过程。

## 核心工作流程

使用本扩展的基本工作流程如下：

1. **设置生成起始点** - 选择从哪条消息后开始生成
2. **准备编辑内容** - 使用消息模板快速获取要修改的内容
3. **执行中间生成** - 发送消息，系统从指定位置开始生成

## 详细使用说明

### 第一步：设置生成起始点

**操作方法：**
1. 找到你希望从其后开始生成消息的位置
2. 在该消息右侧的工具栏中找到"从此往下生成"按钮（魔法棒图标）
3. 点击该按钮，按钮将变为高亮状态，表示已设置为生成起始点
4. 再次点击可取消设置

**设计意图：**
- 通过可视化高亮显示，让用户清楚知道生成将从哪个位置开始
- 防止误操作，确保用户明确选择了起始点

### 第二步：准备编辑内容

设置好生成起始点后，你需要准备要发送的内容。这里消息模板功能就派上用场了。

**为什么要设计消息模板功能？**
当你需要修改上一条消息或编辑已有内容时，手动复制粘贴很麻烦。消息模板功能可以自动将目标消息内容按指定格式插入到输入框，大大简化了编辑操作。

**操作方法：**
1. 在需要修改的消息右侧工具栏中找到"插入模板到输入框"按钮（箭头图标）
2. 点击该按钮，消息内容将按设置的模板格式自动插入到输入框
3. 在输入框中修改内容或添加编辑指示

**模板格式说明：**

**非自定义格式：**
- **完整格式**（默认）：适用于需要完整修改消息内容的场景
  - 对于较长的消息（>100字符）：`请完整修改以上正文内容。\n新生成的正文需要以【消息前30个字符】为开头，以【消息后30个字符】为结尾。\n`
  - 对于较短的消息（≤100字符）：`请完整修改以上正文内容。\n正文为【完整消息内容】\n`
- **简化格式**：适用于简单的修改请求
  - 格式：`请修改以下内容：\n完整消息内容\n`

**自定义格式：**
- 可根据需要自定义模板，支持占位符：
  - `{message}` - 完整消息内容
  - `{message:50}` - 消息的前50个字符
  - `{message:-50}` - 消息的后50个字符

### 第三步：执行中间生成

当起始点已设置且编辑内容已准备就绪后，就可以执行中间生成了。

**操作方法：**
1. 在输入框中输入或修改内容
2. 点击发送按钮
3. 系统将执行以下操作：
   - 从指定起始点后截断对话历史
   - 在起始点后插入新生成的内容
   - 将用户输入的提示词从历史记录中移除
   - 保存并显示更新后的完整对话

**执行过程说明：**
1. 系统首先会从指定的起始点（genid）截断对话历史
2. 然后在该位置开始生成新内容
3. 生成完成后，新内容会插入到起始点之后的位置
4. 用户输入的提示词会被从历史记录中移除
5. 自动滚动到新生成的内容位置

## 实际使用示例

### 示例1：修改AI的错误回复

假设AI生成了一条不符合预期的回复，你想重新生成：

1. 找到AI错误回复的前一条正确消息
2. 点击该消息的"从此往下生成"按钮（设置起始点）
3. 点击错误回复的"插入模板到输入框"按钮（获取内容）
4. 在输入框中修改提示词，如添加"请用更正式的语气回复"
5. 点击发送，系统将从指定位置重新生成内容

### 示例2：完整修改消息内容

想要完整修改某条消息的内容，保持开头和结尾一致，但中间内容不同：

1. 在需要修改的消息后设置生成起始点
2. 点击该消息的"插入模板到输入框"按钮获取当前内容
3. 在输入框中修改提示词，引导AI生成不同的中间内容但保持开头结尾一致
4. 点击发送，系统将生成新的内容替换原消息

## 高级功能

### 导航工具栏

为了方便在长对话中快速定位，扩展提供了导航工具栏：

- **消息ID跳转**：直接跳转到指定ID的消息
- **ID增减按钮**：快速调整当前查看的消息位置
- **生成位置跳转**：一键跳转到当前设置的生成起始点

### 消息历史记录

自动记录发送过的消息，方便快速复用：

- 自动保存最近发送的消息（默认保留100条）
- 支持搜索查找历史消息
- 一键插入最近发送的消息到输入框

## 配置选项

在 SillyTavern 的扩展设置中，你可以配置以下选项：

### 界面组件
- **开启导航工具栏**：启用/禁用消息导航工具栏
- **显示消息生成按钮**：启用/禁用消息生成按钮
- **显示插入模板按钮**：启用/禁用消息模板插入按钮
- **显示最近输入按钮**：启用/禁用最近输入按钮

### 消息历史记录
- **消息历史记录保留数量**：设置保留的历史消息数量（1-500）
- **消息插入模板格式**：选择消息插入的模板格式

## 常见问题

### Q: 中间生成会影响我的原始对话吗？
A: 中间生成会在设置起始点之后插入新生成的内容，并移除用户输入的提示词，而不会替换之后的所有内容。建议在重要对话上使用前先备份。

### Q: 为什么我不能从某些消息开始生成？
A: 系统隐藏消息（如系统提示、注释等）不能作为生成起始点。请确保选择的是可见的用户或角色消息。

### Q: 如何取消已设置的生成起始点？
A: 再次点击已高亮的"从此往下生成"按钮即可取消设置。

## 贡献

欢迎提交 Issue 和 Pull Request 来帮助改进此扩展。

## 许可证

本项目基于 MIT 许可证发布。
